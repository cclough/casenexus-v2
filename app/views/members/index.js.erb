// Re-renders the user list
$("#map_index_users").html("<%= escape_javascript(render("users")) %>")

window.map_index_users_item_bless();


var geoJson_precursor = "<%= escape_javascript(User.markers_geojson(@users).html_safe) %>";

var geoJson = $.parseJSON(geoJson_precursor);

// alert(geoJson);

window.map.markerLayer.setGeoJSON(geoJson);

window.map.setView([51.7519,-1.2578], 14);

map.markerLayer.on('layeradd', function(e) {
    var marker = e.layer,
        feature = marker.feature;

    marker.setIcon(L.icon(feature.properties.icon));
});

map.markerLayer.on('mouseover', function(e) {
    e.layer.openPopup();
});
map.markerLayer.on('mouseout', function(e) {
    e.layer.closePopup();
});


// Tooltips on Avatars
$(".application_avatar_icon").tooltip()

// Marker Click Trigger - Has to be in here because other wise does not load in time for list to be loaded
$('.map_index_users_item_avatar, .map_index_users_item_info, .map_index_users_item_activity').click(function () {

  // var target_id = $(this).parent().attr('data-id');
  // var target_lat = $(this).parent().attr('data-lat');
  // var target_lng = $(this).parent().attr('data-lng');

  // // the problem is something to do with the latlng variable i think! - overlapping with another definition
  // var user_latlng = new google.maps.LatLng(target_lat,target_lng)
  // window.map_index_map_pan(user_latlng)

  // setTimeout((function() {
  //   return window.map_index_load_infobox(target_id);
  // }), 300);

});

// Users Item Cascade Fade
$(".map_index_users_item").each(function (i) {

  if ((i+1) == $(".map_index_users_item").length) {
    $(this).delay((i + 1) * 50).fadeIn(function(){
      $("#map_index_users .pagination").fadeIn(500); 
    });
  } else {
    $(this).delay((i + 1) * 50).fadeIn();
  }

});

// Truncate user item names
window.application_truncatables();


$("#map_index_users .pagination a").on("click", function() {
  $.getScript(this.href);
  return false;
});




