// Re-renders the user list
$("#map_index_users").html("<%= escape_javascript(render("users")) %>")

$("#map_index_users_spinner_container").fadeOut("fast");

if ("<%= @users.count.to_s %>" == "0") {
  $("#map_index_users_empty").fadeIn("fast");
} else {
  $("#map_index_guide_text").html("<%= escape_javascript(render partial: "map/guide",locals: {users: @users} ) %>");
  $("#map_index_guide_text").fadeIn("fast");
}

window.map_index_users_item_bless();

/////////////////////////////////////////////////////////////////////////////////////////
///////////NB ORDER OF STUFF IS IMPORTANT HERE OR YOU GET MARKER FUCKUPS ON LOAD/////////
/////////////////////////////////////////////////////////////////////////////////////////


var geoJson_precursor = "<%= escape_javascript(User.markers_geojson(@users).html_safe) %>";

var geoJson = $.parseJSON(geoJson_precursor);

if (markerLayer) {
  map.removeLayer(markerLayer);
}

var markerLayer = L.mapbox.markerLayer();

markerLayer.on('layeradd', function(e) {
    var marker = e.layer,
        feature = marker.feature;

    marker.setIcon(L.icon(feature.properties.icon));


    marker.on('click', function () {
 
      // pan, offset pan, (zoom?) and show button
      // window.map.setZoom(15);
      window.map.panTo(marker.getLatLng());
      $("#map_index_map_zoomout").fadeIn("fast");

      window.marker_and_popup_actions_for(marker,"perm"); 


      // scroll to item
      var users_item = $("#map_index_users_item_" + feature.properties.id);
      $("#application_container_main").animate({
        scrollTop: users_item.position().top - 5
      }, "fast");
      // activate item
      $('.map_index_users_item').removeClass("map_index_users_item_info_active");
      users_item.addClass("map_index_users_item_info_active");
      

    });

    marker.on('mouseover', function() {
      window.marker_and_popup_actions_for(marker,"temp"); 
    });

    marker.on('mouseout', function() {
        marker.closePopup();
    });

});




// Draw Markers (MUST BE AFTER LAYERADD ABOVE!)
markerLayer.addTo(map);


markerLayer.setGeoJSON(geoJson);








// open tooltip of first marker in list + make user item active - NB RUBY IF
<%- if @users.count > 0 %>

  var firstmarker_id = "<%= j(@users.first.id.to_s) %>";
  markerLayer.eachLayer(function(marker) {

      if (marker.feature.properties.id == firstmarker_id) {

        window.marker_and_popup_actions_for(marker,"perm"); 

        window.map.panTo(marker.getLatLng());
        // $("#map_index_map_zoomout").fadeIn("fast");
      }
  });

  $('.map_index_users_item').removeClass("map_index_users_item_info_active");
  $("#map_index_users").find('.map_index_users_item').first().addClass("map_index_users_item_info_active");
<%- end %>




// If local zoom in, otherwise zoom out
if($("input[name=users_listtype]:eq(0)").is(':checked') || $("input[name=users_listtype]:eq(6)").is(':checked')) {
  window.map.setZoom(15);
  $("#map_index_map_zoomout").fadeIn("fast");
} else {
  // reset zoom out every time list is refreshed
  window.map.setZoom(2);
  $("#map_index_map_zoomout").fadeOut("fast");
}








// Users Item Cascade Fade
$(".map_index_users_item").each(function (i) {

  if ((i+1) == $(".map_index_users_item").length) {
    $(this).delay((i + 1) * 50).fadeIn(function(){
      $("#map_index_users .pagination").fadeIn(500); 
    });
  } else {
    $(this).delay((i + 1) * 50).fadeIn();
  }

});





// Marker Click Trigger - Has to be in here because other wise does not load in time for list to be loaded
$('.map_index_users_item').click(function () {

  // change item color on click
  $('.map_index_users_item').removeClass("map_index_users_item_info_active");
  $(this).addClass("map_index_users_item_info_active");

  // Marker interaction
  var target_id = $(this).attr('data-id');

  markerLayer.eachLayer(function(marker) {

    feature = marker.feature;

    if (feature.properties.id == target_id) {

      window.marker_and_popup_actions_for(marker,"perm"); 

      window.map.setZoom(15,{animate:true});

      window.map.panTo(marker.getLatLng(),{animate:true});

      $("#map_index_map_zoomout").fadeIn("fast");
    }

  });

});


// Marker Click Trigger - Has to be in here because other wise does not load in time for list to be loaded
$('.map_index_users_item').mouseenter(function () {

  // Marker interaction
  var target_id = $(this).attr('data-id');

  markerLayer.eachLayer(function(marker) {

    feature = marker.feature;

    if (feature.properties.id == target_id) {
      window.marker_and_popup_actions_for(marker, "temp"); 
    }

  });

});





// Pagination
$("#map_index_users .pagination a").on("click", function() {
  $.getScript(this.href);
  return false;
});




