// Re-renders the user list
$("#map_index_users").html("<%= escape_javascript(render("users")) %>")

window.map_index_users_item_bless();


var geoJson_precursor = "<%= escape_javascript(User.markers_geojson(@users).html_safe) %>";

var geoJson = $.parseJSON(geoJson_precursor);

// alert(geoJson);

map.markerLayer.setGeoJSON(geoJson);

// map.setView([51.7519,-1.2578], 14);

map.markerLayer.on('layeradd', function(e) {
    var marker = e.layer,
    feature = marker.feature;

    marker.setIcon(L.icon(feature.properties.icon));
});

map.markerLayer.on('mouseover', function(e) {
    e.layer.openPopup();
});
map.markerLayer.on('mouseout', function(e) {
    e.layer.closePopup();
});

window.map.markerLayer.on('click', function(e) {
    window.map.panTo(e.layer.getLatLng());
});


// Open popup when user mouses over a marker
map.markerLayer.on('ready', function(e) {
    var markers = [];
    this.eachLayer(function(marker) { markers.push(marker); });
    cycle(markers);
});

function cycle(markers) {
    var i = 0;
    function run() {
        if (++i > markers.length - 1) i = 0;
        map.setView(markers[i].getLatLng(), 12);
        markers[i].openPopup();
        window.setTimeout(run, 3000);
    }
    run();
}

// Tooltips on Avatars
$(".application_avatar_icon").tooltip()

// Marker Click Trigger - Has to be in here because other wise does not load in time for list to be loaded
$('.map_index_users_item_avatar, .map_index_users_item_info, .map_index_users_item_activity').click(function () {

  var target_id = $(this).parent().attr('data-id');

  map.markerLayer.eachLayer(function(marker) {
      if (marker.feature.properties.id == target_id) {
          marker.openPopup();
          marker.feature.properties.icon['iconUrl'] = 'http://localhost:3000/assets/markers/marker_new_active.png';
          map.markerLayer.setGeoJSON(geoJson);
      }
  });

});

// Users Item Cascade Fade
$(".map_index_users_item").each(function (i) {

  if ((i+1) == $(".map_index_users_item").length) {
    $(this).delay((i + 1) * 50).fadeIn(function(){
      $("#map_index_users .pagination").fadeIn(500); 
    });
  } else {
    $(this).delay((i + 1) * 50).fadeIn();
  }

});

// Truncate user item names
window.application_truncatables();


$("#map_index_users .pagination a").on("click", function() {
  $.getScript(this.href);
  return false;
});




